{% comment %}
  Wholesale Auto-Tagger
  Automatically tags customers with 'wholesale' when they register through the form
  This replaces BSS B2B's auto-tagging functionality
{% endcomment %}

<script>
(function() {
  'use strict';
  
  // Wholesale auto-tagging system
  window.WholesaleAutoTagger = {
    
    // Check if customer needs wholesale tag
    processNewCustomer: function(customerEmail, customerData) {
      // If customer came from wholesale registration form
      if (customerData.tags && customerData.tags.includes('wholesale-application')) {
        this.applyWholesaleTag(customerEmail, customerData);
      }
    },
    
    // Apply wholesale tag via Shopify Customer API
    applyWholesaleTag: function(customerEmail, customerData) {
      // This would typically be handled server-side
      // For now, we'll log the customer for manual review
      console.log('New wholesale customer registered:', {
        email: customerEmail,
        business: customerData.business_name,
        type: customerData.business_type,
        volume: customerData.annual_volume
      });
      
      // Send notification to admin
      this.notifyAdmin(customerData);
    },
    
    // Notify admin of new wholesale application
    notifyAdmin: function(customerData) {
      // Create admin notification payload
      const notification = {
        type: 'wholesale_application',
        customer: customerData,
        timestamp: new Date().toISOString(),
        action_required: 'Review and approve wholesale application'
      };
      
      // In a real implementation, this would send to your admin system
      // For now, we'll store in localStorage for review
      let pendingApplications = JSON.parse(localStorage.getItem('pending_wholesale_applications') || '[]');
      pendingApplications.push(notification);
      localStorage.setItem('pending_wholesale_applications', JSON.stringify(pendingApplications));
      
      console.log('Admin notification queued for wholesale application');
    },
    
    // Check if current customer is wholesale
    isWholesaleCustomer: function() {
      // Check if customer object exists and has wholesale tag
      if (window.customer && window.customer.tags) {
        return window.customer.tags.includes('wholesale');
      }
      return false;
    },
    
    // Initialize wholesale detection
    init: function() {
      // Set global wholesale status
      window.isWholesaleCustomer = this.isWholesaleCustomer();
      
      // Listen for form submissions
      document.addEventListener('DOMContentLoaded', () => {
        const wholesaleForm = document.getElementById('wholesale-registration-form-element');
        if (wholesaleForm) {
          wholesaleForm.addEventListener('submit', this.handleFormSubmission.bind(this));
        }
      });
    },
    
    // Handle wholesale form submission
    handleFormSubmission: function(event) {
      const form = event.target;
      const formData = new FormData(form);
      
      // Extract customer data
      const customerData = {
        first_name: formData.get('contact[first_name]'),
        last_name: formData.get('contact[last_name]'),
        email: formData.get('contact[email]'),
        phone: formData.get('contact[phone]'),
        business_name: formData.get('contact[business_name]'),
        business_type: formData.get('contact[business_type]'),
        city: formData.get('contact[city]'),
        state: formData.get('contact[state]'),
        annual_volume: formData.get('contact[annual_volume]'),
        message: formData.get('contact[message]'),
        tags: ['wholesale-application', 'pending-approval']
      };
      
      // Process the new customer
      this.processNewCustomer(customerData.email, customerData);
    }
  };
  
  // Initialize the auto-tagger
  window.WholesaleAutoTagger.init();
  
})();
</script>

{% comment %} 
  Server-side webhook handler (for implementation)
  This should be implemented as a Shopify webhook or Flow automation:
  
  Webhook: customers/create
  Filter: customer.tags contains 'wholesale-application'
  Action: Add 'wholesale' tag, send admin notification
{% endcomment %}

